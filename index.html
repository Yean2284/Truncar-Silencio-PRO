<!DOCTYPE html>
<html lang="es">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      window.adsbygoogle = window.adsbygoogle || [];
    </script>
    <script>
    function showInterstitial() {
      try {
          if (window.adsbygoogle) {
            adsbygoogle.push({
              google_ad_client: "ca-app-pub-3940256099942544",
              enable_page_level_ads: true
            });
          }
      } catch(e) { console.log("Ad error ignored"); }
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truncar Silencio ULTRA</title>
    <meta name="google-adsense-account" content="ca-app-pub-3940256099942544">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-app-pub-3940256099942544" crossorigin="anonymous"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card-pro { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(168, 85, 247, 0.3); backdrop-filter: blur(15px); }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [isProc, setIsProc] = useState(false);
            const [prog, setProg] = useState(0);
            const [url, setUrl] = useState(null);
            const audioCtx = useRef(null);

            const THRESHOLD = -30; 
            const DURATION = 0.6;

            const handleDownload = (e) => {
                e.preventDefault();
                if (!url) return;
                const link = document.createElement('a');
                link.href = url;
                link.download = 'audio_sin_silencio.mp3';
                document.body.appendChild(link);
                link.click();
                setTimeout(() => document.body.removeChild(link), 100);
            };

            const processAudio = async () => {
                if (!file) return;

                // ADVERTENCIA VISUAL (Ya no bloquea, solo avisa)
                if (file.size > 150 * 1024 * 1024) {
                     if(!confirm("El archivo es gigante (>150MB). El navegador podr√≠a cerrarse si se queda sin RAM. ¬øContinuar bajo tu riesgo?")) return;
                }

                setIsProc(true);
                setProg(1);
                
                if (url) URL.revokeObjectURL(url);
                setUrl(null);

                try {
                    // 1. Forzar Sample Rate a 44100 para AHORRAR MEMORIA en m√≥viles de gama alta
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    // El truco: forzamos 44.1kHz. Si el m√≥vil es de 48k o 96k, esto reduce el uso de RAM a la mitad.
                    if (!audioCtx.current) audioCtx.current = new AudioContext({ sampleRate: 44100 });
                    
                    if (audioCtx.current.state === 'suspended') await audioCtx.current.resume();

                    setProg(5);

                    // 2. Cargar y Decodificar
                    // Usamos variables temporales para poder anularlas manualmente
                    let arrayBuffer = await file.arrayBuffer();
                    
                    // Decodificaci√≥n (Paso cr√≠tico de RAM)
                    let audioBuffer = await audioCtx.current.decodeAudioData(arrayBuffer);
                    
                    // LIBERAR MEMORIA INMEDIATAMENTE
                    arrayBuffer = null; // Adi√≥s al archivo original en RAM
                    
                    let data = audioBuffer.getChannelData(0); // Referencia a datos crudos
                    const rate = audioBuffer.sampleRate; // Deber√≠a ser 44100 gracias al constructor
                    
                    // Liberar el objeto AudioBuffer contenedor, qued√°ndonos solo con los datos raw
                    audioBuffer = null; 

                    const limit = Math.pow(10, THRESHOLD / 20);
                    const minSilence = Math.floor(DURATION * rate);
                    
                    // 3. Encoder MP3 y Buffers Est√°ticos
                    const mp3enc = new lamejs.Mp3Encoder(1, rate, 128);
                    const chunks = [];
                    
                    const BLOCK_SIZE = 1152;
                    const floatBuffer = new Float32Array(BLOCK_SIZE);
                    let bufferIndex = 0;
                    
                    const encodeBlock = () => {
                        const i16 = new Int16Array(BLOCK_SIZE);
                        for(let j=0; j<BLOCK_SIZE; j++) {
                            // Clamp manual optimizado
                            let v = floatBuffer[j];
                            if (v > 1) v = 1; else if (v < -1) v = -1;
                            i16[j] = v < 0 ? v * 0x8000 : v * 0x7FFF;
                        }
                        const encoded = mp3enc.encodeBuffer(i16);
                        if (encoded.length > 0) chunks.push(encoded);
                        bufferIndex = 0;
                    };

                    let i = 0;
                    let lastUpdate = Date.now();
                    const totalLen = data.length;
                    
                    // Optimizaci√≥n: Extraer longitud a variable local para velocidad
                    const dLen = data.length;

                    // --- BUCLE DE PROCESAMIENTO ---
                    while (i < dLen) {
                        
                        // Si el valor absoluto es menor al l√≠mite (Silencio)
                        if (Math.abs(data[i]) < limit) {
                            let s = i;
                            // Avanzar √≠ndice mientras haya silencio
                            while (i < dLen && Math.abs(data[i]) < limit) i++;
                            
                            const silenceLen = i - s;
                            
                            if (silenceLen >= minSilence) {
                                // ES UN SILENCIO LARGO: Insertar micro-puente (0.05s) para suavidad
                                const bridge = Math.floor(0.05 * rate);
                                for (let k = 0; k < bridge; k++) {
                                    floatBuffer[bufferIndex++] = 0;
                                    if (bufferIndex === BLOCK_SIZE) encodeBlock();
                                }
                            } else {
                                // ES UN SILENCIO CORTO: Copiarlo (no se borra)
                                for (let k = s; k < i; k++) {
                                    floatBuffer[bufferIndex++] = data[k];
                                    if (bufferIndex === BLOCK_SIZE) encodeBlock();
                                }
                            }
                        } else {
                            // ES SONIDO: Copiar
                            floatBuffer[bufferIndex++] = data[i];
                            if (bufferIndex === BLOCK_SIZE) encodeBlock();
                            i++;
                        }

                        // Liberar hilo principal cada ~250ms para evitar congelamiento
                        if (Date.now() - lastUpdate > 250) {
                            const p = Math.floor((i / dLen) * 98);
                            setProg(p);
                            // SetTimeout 0 permite al navegador refrescar la pantalla y manejar eventos
                            await new Promise(r => setTimeout(r, 0));
                            lastUpdate = Date.now();
                        }
                    }

                    // Limpiar array de entrada gigante antes de finalizar
                    data = null; 

                    // Procesar remanente
                    if (bufferIndex > 0) {
                         const i16 = new Int16Array(bufferIndex);
                         for(let j=0; j<bufferIndex; j++) {
                             let v = floatBuffer[j];
                             if (v > 1) v = 1; else if (v < -1) v = -1;
                             i16[j] = v < 0 ? v * 0x8000 : v * 0x7FFF;
                         }
                         const encoded = mp3enc.encodeBuffer(i16);
                         if (encoded.length > 0) chunks.push(encoded);
                    }

                    const mp3last = mp3enc.flush();
                    if (mp3last.length > 0) chunks.push(mp3last);

                    // Crear Blob final
                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    setUrl(URL.createObjectURL(blob));
                    setProg(100);
                    
                    showInterstitial();

                } catch (e) { 
                    console.error(e);
                    // Si falla aqu√≠, es f√≠sico (RAM del dispositivo llena)
                    alert("Error: Memoria insuficiente. El archivo es demasiado grande para la RAM disponible en este momento."); 
                }
                setIsProc(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-6 bg-[#090e1a]">
                    <div className="w-full max-w-md card-pro p-8 rounded-[2.5rem] mt-10 shadow-2xl border-t border-white/10">
                        <h1 className="text-center text-2xl font-black mb-8 text-purple-400 italic uppercase tracking-tighter">Truncar Silencio PRO</h1>
                        
                        <div className="border-2 border-dashed border-purple-500/20 rounded-3xl p-8 text-center mb-6 bg-slate-900/50">
                            <input type="file" onChange={e => {setFile(e.target.files[0]); setUrl(null);}} className="hidden" id="aud" accept="audio/*" />
                            <label htmlFor="aud" className="cursor-pointer block">
                                <span className="text-4xl block mb-2">{file ? "‚úÖ" : "üìÅ"}</span>
                                <span className="text-xs text-purple-200 font-bold uppercase truncate block">
                                    {file ? file.name : "Seleccionar Audio (+150MB Support)"}
                                </span>
                            </label>
                        </div>

                        {isProc && (
                            <div className="mb-6">
                                <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden">
                                    <div className="bg-purple-500 h-full progress-bar-fill" style={{ width: `${prog}%` }}></div>
                                </div>
                                <p className="text-center text-[10px] mt-2 text-purple-300 font-bold">{prog}% COMPLETADO</p>
                                <p className="text-center text-[8px] text-gray-500">No cierres esta pesta√±a</p>
                            </div>
                        )}

                        {!url ? (
                            <button onClick={processAudio} disabled={!file || isProc} className="w-full bg-purple-600 hover:bg-purple-500 disabled:opacity-30 py-5 rounded-3xl font-black text-lg shadow-lg transition-all text-white border-b-4 border-purple-800">
                                {isProc ? "PROCESANDO..." : "ELIMINAR SILENCIOS"}
                            </button>
                        ) : (
                            <div className="space-y-4 text-center">
                                <button onClick={handleDownload} className="w-full bg-emerald-600 hover:bg-emerald-500 py-5 rounded-3xl font-black text-lg block shadow-lg border-b-4 border-emerald-800 text-white uppercase">
                                    DESCARGAR MP3 ‚úÖ
                                </button>
                                <button onClick={() => {setUrl(null); setProg(0); setFile(null);}} className="text-[10px] text-gray-500 uppercase font-bold">Procesar otro</button>
                            </div>
                        )}
                    </div>

                    <div className="mt-12 text-center pb-10">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-[0.3em] mb-1">Desarrollado por</p>
                        <p className="text-md font-black text-purple-100 tracking-widest uppercase">YEAN CARLOS GODOY GONZALEZ</p>
                        <p className="text-[9px] text-gray-600 font-bold mt-2">¬© 2025 TODOS LOS DERECHOS RESERVADOS</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
