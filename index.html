<!DOCTYPE html>
<html lang="es">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      window.adsbygoogle = window.adsbygoogle || [];
    </script>
    <script>
    function showInterstitial() {
      try {
          if (window.adsbygoogle) {
            adsbygoogle.push({
              google_ad_client: "ca-app-pub-3940256099942544",
              enable_page_level_ads: true
            });
          }
      } catch(e) { console.log("Ad error ignored"); }
    }
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Truncar Silencio ULTRA STABLE</title>
    <meta name="google-adsense-account" content="ca-app-pub-3940256099942544">
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-app-pub-3940256099942544" crossorigin="anonymous"></script>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#7c3aed">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.all.min.js"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        body { background: #0f172a; color: white; font-family: sans-serif; -webkit-tap-highlight-color: transparent; }
        .card-pro { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(168, 85, 247, 0.3); backdrop-filter: blur(15px); }
        .progress-bar-fill { transition: width 0.3s ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [file, setFile] = useState(null);
            const [isProc, setIsProc] = useState(false);
            const [prog, setProg] = useState(0);
            const [status, setStatus] = useState("");
            const [url, setUrl] = useState(null);
            const audioCtx = useRef(null);

            const THRESHOLD = -30; 
            const DURATION = 0.6;

            const handleDownload = (e) => {
                e.preventDefault();
                if (!url) return;
                const link = document.createElement('a');
                link.href = url;
                link.download = 'audio_sin_silencio.mp3';
                document.body.appendChild(link);
                link.click();
                setTimeout(() => document.body.removeChild(link), 100);
            };

            const processAudio = async () => {
                if (!file) return;

                // Alerta suave para archivos enormes
                if (file.size > 100 * 1024 * 1024) {
                     setStatus("Archivo grande detectado. Usando modo 'Ahorro de Memoria'...");
                     await new Promise(r => setTimeout(r, 1000));
                }

                setIsProc(true);
                setProg(1);
                
                if (url) URL.revokeObjectURL(url);
                setUrl(null);

                try {
                    setStatus("Preparando motor de audio...");
                    await new Promise(r => setTimeout(r, 50));

                    // 1. EL TRUCO: Forzar 22050Hz.
                    // Esto reduce el tama√±o del audio en RAM a la MITAD.
                    // Fundamental para que archivos de 150MB+ no cierren el navegador.
                    const AudioContext = window.AudioContext || window.webkitAudioContext;
                    
                    // Si ya exist√≠a un contexto, ci√©rralo para liberar memoria antigua
                    if (audioCtx.current) {
                        try { await audioCtx.current.close(); } catch(e){}
                    }
                    audioCtx.current = new AudioContext({ sampleRate: 22050 });

                    setProg(5);
                    setStatus("Cargando archivo en memoria...");

                    // 2. Cargar ArrayBuffer
                    let arrayBuffer = await file.arrayBuffer();
                    
                    setProg(15);
                    setStatus("Decodificando (Esto puede tardar)...");
                    
                    // 3. Decodificar
                    // Este es el momento cr√≠tico donde suele fallar. Al usar 22050Hz arriba, deber√≠a aguantar.
                    let audioBuffer = await audioCtx.current.decodeAudioData(arrayBuffer);
                    
                    // LIBERAR RAM INMEDIATAMENTE
                    arrayBuffer = null; // Borramos el archivo comprimido de la RAM
                    
                    let data = audioBuffer.getChannelData(0); 
                    const rate = audioBuffer.sampleRate; // Ser√° 22050
                    
                    // Liberar el contenedor de audioBuffer
                    audioBuffer = null;

                    setProg(30);
                    setStatus("Analizando y eliminando silencios...");

                    const limit = Math.pow(10, THRESHOLD / 20);
                    const minSilence = Math.floor(DURATION * rate);
                    
                    // 4. Encoder MP3
                    const mp3enc = new lamejs.Mp3Encoder(1, rate, 128); // 128kbps es suficiente para 22khz
                    const chunks = [];
                    
                    const BLOCK_SIZE = 1152;
                    const floatBuffer = new Float32Array(BLOCK_SIZE);
                    let bufferIndex = 0;
                    
                    const encodeBlock = () => {
                        const i16 = new Int16Array(BLOCK_SIZE);
                        for(let j=0; j<BLOCK_SIZE; j++) {
                            let v = floatBuffer[j];
                            if (v > 1) v = 1; else if (v < -1) v = -1;
                            i16[j] = v < 0 ? v * 0x8000 : v * 0x7FFF;
                        }
                        const encoded = mp3enc.encodeBuffer(i16);
                        if (encoded.length > 0) chunks.push(encoded);
                        bufferIndex = 0;
                    };

                    let i = 0;
                    let lastUpdate = Date.now();
                    const totalLen = data.length;
                    
                    // Bucle de procesamiento
                    while (i < totalLen) {
                        if (Math.abs(data[i]) < limit) {
                            let s = i;
                            while (i < totalLen && Math.abs(data[i]) < limit) i++;
                            
                            const silenceLen = i - s;
                            if (silenceLen >= minSilence) {
                                // Reducir silencio a 0.1s
                                const bridge = Math.floor(0.1 * rate);
                                for (let k = 0; k < bridge; k++) {
                                    floatBuffer[bufferIndex++] = 0;
                                    if (bufferIndex === BLOCK_SIZE) encodeBlock();
                                }
                            } else {
                                for (let k = s; k < i; k++) {
                                    floatBuffer[bufferIndex++] = data[k];
                                    if (bufferIndex === BLOCK_SIZE) encodeBlock();
                                }
                            }
                        } else {
                            floatBuffer[bufferIndex++] = data[i];
                            if (bufferIndex === BLOCK_SIZE) encodeBlock();
                            i++;
                        }

                        // Actualizar UI con m√°s frecuencia para evitar timeouts
                        if (Date.now() - lastUpdate > 300) {
                            const percent = 30 + Math.floor((i / totalLen) * 65);
                            setProg(percent);
                            setStatus(`Procesando... ${Math.floor((i / totalLen) * 100)}%`);
                            await new Promise(r => setTimeout(r, 0));
                            lastUpdate = Date.now();
                        }
                    }

                    setStatus("Generando MP3 final...");
                    data = null; // Liberar datos crudos antes de generar el blob

                    if (bufferIndex > 0) {
                         const i16 = new Int16Array(bufferIndex);
                         for(let j=0; j<bufferIndex; j++) {
                             let v = floatBuffer[j];
                             if (v > 1) v = 1; else if (v < -1) v = -1;
                             i16[j] = v < 0 ? v * 0x8000 : v * 0x7FFF;
                         }
                         const encoded = mp3enc.encodeBuffer(i16);
                         if (encoded.length > 0) chunks.push(encoded);
                    }

                    const mp3last = mp3enc.flush();
                    if (mp3last.length > 0) chunks.push(mp3last);

                    const blob = new Blob(chunks, { type: 'audio/mp3' });
                    setUrl(URL.createObjectURL(blob));
                    setProg(100);
                    setStatus("¬°Completado!");
                    
                    showInterstitial();

                } catch (e) { 
                    console.error(e);
                    alert("Error: Memoria insuficiente incluso en modo ahorro. El archivo es excesivamente grande para un navegador m√≥vil."); 
                    setStatus("Error de memoria.");
                }
                setIsProc(false);
            };

            return (
                <div className="min-h-screen flex flex-col items-center p-6 bg-[#090e1a]">
                    <div className="w-full max-w-md card-pro p-8 rounded-[2.5rem] mt-10 shadow-2xl border-t border-white/10">
                        <h1 className="text-center text-2xl font-black mb-8 text-purple-400 italic uppercase tracking-tighter">Truncar Silencio PRO</h1>
                        
                        <div className="border-2 border-dashed border-purple-500/20 rounded-3xl p-8 text-center mb-6 bg-slate-900/50">
                            <input type="file" onChange={e => {setFile(e.target.files[0]); setUrl(null); setStatus(""); setProg(0);}} className="hidden" id="aud" accept="audio/*" />
                            <label htmlFor="aud" className="cursor-pointer block">
                                <span className="text-4xl block mb-2">{file ? "‚úÖ" : "üìÅ"}</span>
                                <span className="text-xs text-purple-200 font-bold uppercase truncate block">
                                    {file ? file.name : "Seleccionar Audio (+150MB)"}
                                </span>
                            </label>
                        </div>

                        {isProc && (
                            <div className="mb-6">
                                <div className="w-full bg-slate-900 rounded-full h-1.5 overflow-hidden">
                                    <div className="bg-purple-500 h-full progress-bar-fill" style={{ width: `${prog}%` }}></div>
                                </div>
                                <p className="text-center text-[10px] mt-2 text-purple-300 font-bold uppercase">{status || "INICIANDO..."}</p>
                            </div>
                        )}

                        {!url ? (
                            <button onClick={processAudio} disabled={!file || isProc} className="w-full bg-purple-600 hover:bg-purple-500 disabled:opacity-30 py-5 rounded-3xl font-black text-lg shadow-lg transition-all text-white border-b-4 border-purple-800">
                                {isProc ? "TRABAJANDO..." : "ELIMINAR SILENCIOS"}
                            </button>
                        ) : (
                            <div className="space-y-4 text-center">
                                <button onClick={handleDownload} className="w-full bg-emerald-600 hover:bg-emerald-500 py-5 rounded-3xl font-black text-lg block shadow-lg border-b-4 border-emerald-800 text-white uppercase">
                                    DESCARGAR MP3 ‚úÖ
                                </button>
                                <button onClick={() => {setUrl(null); setProg(0); setFile(null); setStatus("");}} className="text-[10px] text-gray-500 uppercase font-bold">Procesar otro</button>
                            </div>
                        )}
                    </div>

                    <div className="mt-12 text-center pb-10">
                        <p className="text-[10px] text-gray-500 uppercase font-bold tracking-[0.3em] mb-1">Desarrollado por</p>
                        <p className="text-md font-black text-purple-100 tracking-widest uppercase">YEAN CARLOS GODOY GONZALEZ</p>
                        <p className="text-[9px] text-gray-600 font-bold mt-2">¬© 2025 TODOS LOS DERECHOS RESERVADOS</p>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
